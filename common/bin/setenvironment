#!/bin/bash

# Copyright 2011 Boris Kogan (boris@thekogans.net)
#
# This file is part of thekogans_toolchain.
#
# thekogans_toolchain is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# thekogans_toolchain is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with thekogans_toolchain. If not, see <http://www.gnu.org/licenses/>.

# This script will setup the environment for building with
# thekogans.net development environment and toolchain.

TOOLCHAIN_ROOT="$(dirname $(dirname $(cd $(dirname ${BASH_SOURCE[0]}) && pwd)))"
TOOLCHAIN_COMMON_BIN="$TOOLCHAIN_ROOT"/common/bin

if [ -e "$TOOLCHAIN_COMMON_BIN"/version ]; then
    . "$TOOLCHAIN_COMMON_BIN"/version
else
    echo "Unable to find $TOOLCHAIN_COMMON_BIN/version."
    exit 1
fi

# Fill in what's missing from the environmnet with defaults provided during bootstrap.
if [ -e "$TOOLCHAIN_ROOT"/defaultenvironment ]; then
    . "$TOOLCHAIN_ROOT"/defaultenvironment
fi

# Parse the command line.
for i in "$@"; do
    case $i in
        -tv|--toolchain-version)
            echo "thekogans.net toolchain and build system version: \
$TOOLCHAIN_MAJOR_VERSION"."$TOOLCHAIN_MINOR_VERSION"."$TOOLCHAIN_PATCH_VERSION"
            exit 0
            ;;
        -os:*|--operating-system:*)
            TOOLCHAIN_OS="${i#*:}"
            ;;
        -arch:*|--architecture:*)
            TOOLCHAIN_ARCH="${i#*:}"
            ;;
        -comp:*|--compiler:*)
            TOOLCHAIN_COMPILER="${i#*:}"
            ;;
        -nc:*|--naming-convention:*)
            TOOLCHAIN_NAMING_CONVENTION="${i#*:}"
            ;;
        -dr:*|--development-root:*)
            DEVELOPMENT_ROOT="${i#*:}"
            ;;
        -do:*|--default-organization:*)
            TOOLCHAIN_DEFAULT_ORGANIZATION="${i#*:}"
            ;;
        -dp:*|--default-project:*)
            TOOLCHAIN_DEFAULT_PROJECT="${i#*:}"
            ;;
        -db:*|--default-branch:*)
            TOOLCHAIN_DEFAULT_BRANCH="${i#*:}"
            ;;
        -ds:*|--default-svc:*)
            TOOLCHAIN_DEFAULT_SVC="${i#*:}"
            ;;
    esac
done

# Default the naming convention to Hierarchical if none is given.
if [ "$TOOLCHAIN_NAMING_CONVENTION" == "" ]; then
    TOOLCHAIN_NAMING_CONVENTION=Hierarchical
fi

environment_options="\
[-tv | --toolchain-version] \
[[-os | --operating-system]:[Windows | OSX | Linux | ...]] \
[[-arch | --architecture]:[i386 | x86_64 | ...]] \
[[-comp | --compiler]:compiler] \
[[-nc | --naming-convention]:[Flat | Hierarchical]] \
[[-dr | --development-root]:development_root] \
[[-do | --default-organization]:default_organization] \
[[-dp | --default-project]:default_project] \
[[-db | --default-branch]:[trunk | branches/branch | tags/tag]] \
[[-ds | --default-svc]:[svn | git]]"

# Check if the TOOLCHAIN_TRIPLET was specified.
if [ "$TOOLCHAIN_OS" == "" ] || [ "$TOOLCHAIN_ARCH" == "" ] || [ "$TOOLCHAIN_COMPILER" == "" ]; then
    echo "usage: $0 $environment_options"
    exit 1
fi

# Validate naming_convention.
if [ "$TOOLCHAIN_NAMING_CONVENTION" != "Flat" ] && [ "$TOOLCHAIN_NAMING_CONVENTION" != "Hierarchical" ]; then
    echo "Unknown naming convention [-nc | --naming-convention]: $TOOLCHAIN_NAMING_CONVENTION [Flat | Hierarchical]"
    exit 1
fi

# Discover the environment...
if [ "$DEVELOPMENT_ROOT" != "" ]; then
    DEVELOPMENT_ROOT="$(cd $DEVELOPMENT_ROOT && pwd)"
else
    DEVELOPMENT_ROOT="$(dirname $TOOLCHAIN_ROOT)"
fi
TOOLCHAIN_NAME="$(basename $TOOLCHAIN_ROOT)"
if [ `echo -n I | od -to2 | awk '{print substr($2,6,1); exit}'` == 1 ]; then
    TOOLCHAIN_ENDIAN=Little
else
    TOOLCHAIN_ENDIAN=Big
fi
TOOLCHAIN_BRANCH="$TOOLCHAIN_OS"/"$TOOLCHAIN_ARCH"/"$TOOLCHAIN_COMPILER"
TOOLCHAIN_DIR="$TOOLCHAIN_ROOT"/"$TOOLCHAIN_BRANCH"
if [ ! -d "$TOOLCHAIN_DIR" ]; then
    echo "Toolchain $TOOLCHAIN_DIR does not exist."
    exit 1
fi
TOOLCHAIN_TRIPLET="$TOOLCHAIN_OS"-"$TOOLCHAIN_ARCH"-"$TOOLCHAIN_COMPILER"
TOOLCHAIN_SHELL=`which bash`
if [ ! -e "$TOOLCHAIN_SHELL" ]; then
    echo "System shell (bash) is missing."
    exit 1
fi

# ...and export it.
export TOOLCHAIN_OS \
    TOOLCHAIN_ARCH \
    TOOLCHAIN_COMPILER \
    TOOLCHAIN_NAMING_CONVENTION \
    DEVELOPMENT_ROOT \
    TOOLCHAIN_DEFAULT_ORGANIZATION \
    TOOLCHAIN_DEFAULT_PROJECT \
    TOOLCHAIN_DEFAULT_BRANCH \
    TOOLCHAIN_DEFAULT_SVC \
    TOOLCHAIN_NAME \
    TOOLCHAIN_ROOT \
    TOOLCHAIN_COMMON_BIN \
    TOOLCHAIN_ENDIAN \
    TOOLCHAIN_BRANCH \
    TOOLCHAIN_DIR \
    TOOLCHAIN_TRIPLET \
    TOOLCHAIN_SHELL

# Pull in toolchain specific environment (if specified).
if [ -e "$TOOLCHAIN_ROOT"/common/setenvironment ]; then
    . "$TOOLCHAIN_ROOT"/common/setenvironment "$@"
fi
if [ -e "$TOOLCHAIN_ROOT"/"$TOOLCHAIN_OS"/setenvironment ]; then
    . "$TOOLCHAIN_ROOT"/"$TOOLCHAIN_OS"/setenvironment "$@"
fi
if [ -e "$TOOLCHAIN_ROOT"/"$TOOLCHAIN_OS"/"$TOOLCHAIN_ARCH"/setenvironment ]; then
    . "$TOOLCHAIN_ROOT"/"$TOOLCHAIN_OS"/"$TOOLCHAIN_ARCH"/setenvironment "$@"
fi
if [ -e "$TOOLCHAIN_DIR"/setenvironment ]; then
    . "$TOOLCHAIN_DIR"/setenvironment "$@"
fi

# Pull in a bunch of useful utility functions.
. "$TOOLCHAIN_COMMON_BIN"/utils
